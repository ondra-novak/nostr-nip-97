NIP-61 Identity providers
=========================

Introduces a feature to identify the user using trusted identity providers

Motivation
----------

The goal is to make onboarding easier for new users who may find managing their private key difficult. This proposal unifies the way in which a client should find and reach the identity provider of a particular user. This proposal does not define how keys are to be stored with the provider and protected from misuse, assuming that the user trusts their provider.

NIP-05 extension
----------------
This proposal extends NIP-05. A new key is added to the JSON document defined in NIP-05:

```json
{
  "names": {
    "bob": "b0635d6a9851d3aed0cd6c495b282167acf761729078d975fc341b22650b07b9"
  },
  "relays": {
    "b0635d6a9851d3aed0cd6c495b282167acf761729078d975fc341b22650b07b9": [ "wss://relay.example.com", "wss://relay2.example.com" ]
  },
  "login":"https://ip.example.com/login"      
}
````

The new `login` entry says that there is an identity provider which handles login for users on this domain. It doesn't says which users can use this service

This URL still needs to be modified by adding parameters

```
Login:
https://ip.example.com/login?action=login&type=...&name=....&reqid=...&return_url=....&client=...

Retrieve result:
https://ip.example.com/login?action=result&reqid=...
```

* **action** - `login` - perform login, `result` - retrieve result
* **type** - can be `nsec`,`nip7`,`nip46`,`nip26`. The client chooses the type according to what it supports. The identity provider don't need to support all types
    * **nsec** - the client needs private key. 
    * **nip7** - the client needs url to a script which installs NIP-07 extension (temporalily)
    * **nip46** - the client needs signer NIP-46
    * **nip26** - the client needs delegation token NIP-26
* **name** - name of the user
* **reqid** - random identifier of this request, which is need later to retrieve the result. It can be any **random** string, recommended length is 30 ascii characters.
* **return_url** - url, where the user agent is redirected after successful login.
* **client** - optional url to client's metadata. The domain of the URL must match to domain of `return_url` unless the return_url is not HTTP URL (for example it is an intent). The format of the metadata is a JSON as defined in NIP-46


Example - initiate login
-------------------------

```
login: https://ip.example.com/login
action: login
type: nip46
name: bob
reqid: K7HcV7WqL5DSxySysLr8zRQCJa8BD6
return_url: https://awesome.nostr.client.com/login_done
```

**Final url**


```
https://ip.example.com/login?action=login&type=nip46&name=bob&reqid=K7HcV7WqL5DSxySysLr8zRQCJa8BD6&return_url=https%3A%2F%2Fawesome.nostr.client.com%2Flogin_done
```

Example - retrieve result
-------------------------

```
login: https://ip.example.com/login
action: result
reqid: K7HcV7WqL5DSxySysLr8zRQCJa8BD6
```

**Final url**

```
https://ip.example.com/login?action=result&reqid=K7HcV7WqL5DSxySysLr8zRQCJa8BD6
```


Protocol flow
-------------
1. Client: generates `reqid`
2. Client: constructs URL `initiate login`
3. Opens url in a web browser. Monitors the browser for `return_url`
4. Identity provider: shows a web page and allows user to perform the login procedure.
5. Identity provider: redirects to `return_url`
6. Client: constructs URL `retrieve result`
7. Client: Loads content of the URL (GET) and retrieves the result

Result
------

```json
{
   "nsec":"....",
   "script":"....",
   "relay":"...",
   "pubkey":"....",
   "delegation":["delegation","hex","options"],
}
```

* **nsec** - appears only for `type=nsec` and contains a private key of the user (to be used in the client to sign events)
* **script** - appears only for `type=nip7` and contains an URL to a javascript file, which can be loaded to a web client and which implements NIP-07
* **relay** - appears only for `type=nip46` and contains a relay where the signer listens for request 
* **pubkey** - appears only for `type=nip46` and contains a pubkey of the signer
* **delegation** - appears only for `type=nip26` and contains delegation tag

Security notes
-----------------------

The user must be well informed to whom he/she is granting access to his/her account and there must be no possibility to falsify this information

The identity provider should display the client's FQDN before the user logs in. It must extract the domain from the return_url. The client can supply a URL for the metadata, but this url must be from the same domain. Then the identity provider can also display the client icon and description. However, displaying the FQDN is mandatory. If the return_url is not an HTTP URL, then the identity provider must recognize the protocol type and display the representative part of the link to the user, which contains the application identification. If this is not possible, the identity provider may refuse to continue the operation

A user can only grant limited access to their account, either limiting it in time or limiting the set of `kinds` that can be signed. This is possible for all login types except type=nsec

The type=nsec is the least secure mode and should really be used where no other login method is possible. The identity provider may not support this type for security reasons. However, it remains in the proposal for the sake of defining a standard forwarding of this object

The `reqid` can only be used once. The content associated with `reqid` must be deleted after successful retrieval.

Other identity provider's features
--------------------------------

* create account
* associate NIP-05 with account
* import private key
* export private key
* delete account

Identity provider is obliged to delete all identity information if the account is deleted

The identity provider should store the private key in encrypted form. To decrypt the key, the provider should use user-supplied information, such as a password. The password can be stored either as a salted hash (for access authentication) and/or can be used to KDF to obtain the encryption key to decrypt the stored private key. 

It is recommended to require two-factor authentication

```
Client
┌────────────────────────────┐
│                            │
│        ┌─────────────────┐ │
│ Ident: │ bob@example.com │ │
│        └─────────────────┘ │
│                 .          │
│                 ┌───────┐  │
│                 │  Next │  │
│                 └───────┘  │
│                            │
└────────────────────────────┘


Identity provider
┌────────────────────────────┐
│                            │
│ awesome.client.nostr.com   │
│          ┌────┐            │
│          ├─►▼ │ (icon)     │
│          │ ▲◄─┤            │
│          └────┘            │
│                            │
│ Password:     ********     │
│                            │
│                            │
│                            │
│ 0 Short messages           │
│                            │
│ O Edit profile             │
│                            │
│ 0 Direct messages          │
│                            │
│              ┌────────┐    │
│              │ Login  │    │
│              └────────┘    │
│                            │
└────────────────────────────┘

Client
┌────────────────────────────┐
│                            │
│                            │
│   Logged in                │
│                            │
│                            │
│                            │
│                            │
│                            │
└────────────────────────────┘
```