NIP-97: Files hosted on relay
==============================

`final` `optional` `author:ondra-novak`

This NIP solves the problem of sharing and distributing binary content over NOSTR networks such as media - images, short videos, music, or in general any files up to a certain size

Key Takeaways
-------------

* Builds on NIP-94
* Defines how binary content (images, media, files) is managed by NOSTR network
* Allows sending private binary content in direct messages (encrypted)
* Defines new commands at the protocol level ("STORE","RETRIEVE")
* Uses the binary messages in the websocket connection


Changes in file header (NIP-94)
------------------------


* **url is optional** - The item can be filled with a link to an external server. This may help during the transition period when the client is uploading the file to third party servers for relays that do not support this NIP
* **s** - (storage) possible values: `local`, `url`, `torrent`, `ordinals`
    *   **local** - file is stored locally on the relay (mandatory for this NIP)
    *   **url** - file is stored externally available through the url
    *   **torrent** - file is stored on torrent
    *   **ordinals** - file is stored in Bitcoin blockchain as an ordinal
    *   **(missing)** - the client must follow the other tags. In any case, the file is not hosted on the relay


**Explanation**: the original intention was to add a tag to distinguish between external and internal file locations. However, this tag would be better used to refine the location of the file. Thus, the values are listed as an example, except for the **local** value, which indicates that file is hosted on the relay

**NOTE** - when copying events from one relay to another, the service must check for the presence of a tag `["s":"local"]` and, if such a tag exists on the event, it must also ensure that the binary content is copied as well

**Compatibility note** - Since there are probably many relays and proxies that do not support this NIP, it may happen that the event will be copied without binary content. If a client discovers, that the relay does not have that content, or does not even support binary content, the client is not required to look for that content elsewhere, instead it can indicate to the user the unavailability of that content.

**New format of the event**

```json
{
  "id": <32-bytes lowercase hex-encoded sha256 of the the serialized event data>,
  "pubkey": <32-bytes lowercase hex-encoded public key of the event creator>,
  "created_at": <unix timestamp in seconds>,
  "kind": 1063,
  "tags": [
    ["s":"<local/url/torrent/....>"],
    ["url",<optional - string with URI of file>],
    ["aes-256-gcm",<key>, <iv>],
    ["m", <MIME type>],
    ["x",<Hash SHA-256>],
    ["size", <size of file in bytes>],
    ["dim", <size of file in pixels>],
    ["blurhash", <value>]
  ],
  "content": <description>,
  "sig": <64-bytes hex of the signature of the sha256 hash of the serialized event data, which is the same as the "id" field>
}
```


Upload
------

A new protocol level command is introduced for upload: `STORE`

**Protocol flow**

```
client: ["STORE", <event>]
relay:  ["OK","<event-id">,true,"continue"]
client: <binary message - content of the file>
relay:  ["OK",<event-id>, true, ""]
```
**Explanation**: the client must signal to the relay that it is about to send binary content. There are following reasons for this.

 * Communication between the client and the relay takes place over a text channel. The binary channel has no use before the introduction of this NIP. However, this may change in the future. The binary transfer announcement solves the forward compatibility problem. Relay will thus get information that the next binary transfer will be related to an upload of binary content. This allows the binary channel to be used for other purposes in the future outside the scope of this command.
 * There is an focus on the simplest possible implementation of the protocol on the client side. Upload of binary content is done by simply sending the entire file as a binary message, without the need to process the binary content further (unless the content is encrypted)
* If the client issues this command on a relay that does not support this NIP, it doesn't receive the expected response from the relay and should give up trying to push the binary file somewhere where no one can process it.
* Pre-upload notifications can help the relay to check that the binary content arrived safely, for example to verify the file hash and the size

** Command arguments **

The command argument is an event of type "kind: 1063". Tags: `x`, `size` and `m` are mandatory.

The event is published after successful binary transfer.

** Responses **

Response to the command `STORE` is `OK`, with status `true` - which signals that relay is ready to accept a binary message as binary content of the file. The text part of the response is just informational for debugging purpose.

If the relay respons with status `false`, or the response is not `OK` message, the client MUST NOT send any binary message. The text part of the response contains explanation of the error (similar to NIP-20)

The relay must also respond once it receives the binary message if it was correctly announced using the `STORE` command and the content of the binary message matches the announced event (has the correct hash and size). The response is also `OK`, with status `true` for success or `false` for failure.

This proposal doesn't define response for binary messages sent without the announcement

** Rules for state control **

1. The relay SHOULD NOT accept any binary message without prior anouncement.
2. The relay SHOULD publish event after successful binary transfer.
3. The relay MUST NOT publish an event with incomplette binary transfer.
4. If a `STORE` command is sent after another `STORE` without sending a binary message between them, the previous operation is cancelled and the associated event MUST NOT be published.
5. If a client sends `STORE` command and then closes the connection without sending a  binary message, the operation is canceled and event MUST NOT be published.
6. If the connection is closed during reading a binary message (continuation frames), the operation is canceled and event MUST NOT be published.
7. If the received binary message is corrupted (hash or size doesn't match), the relay MUST NOT publish the event and signal this to the client using appropriate response.
8. Relay is free to choose not to accept binary content for any reason. For example, Relay may test submitted images for explicit or copyrighted content and reject such content.

** Special error messages **

* `max_size: <size in bytes>` - this error message informs that file is too big.
* `invalid: file mismatch` - received binary content doesn't match to announced metadata in the associated event


**Recommendation**: A relay that supports this NIP SHOULD check whether event 1063 with the `local` flag is being published without the associated binary content.

```
client: ["EVENT",{"id","abc123","kind":1063,"tags":[["s","local"],....],....}]
relay: ["OK","abc123",false,"invalid: use command STORE"]
```


Download
--------

The `RETRIEVE` command is used to download the binary file from the relay

**Protocol flow**

```
client: ["RETRIEVE","<event-id>"]
relay:  ["OK","<event-id>", true, ""]
relay:  <binary message>
```

If the binary file does not exist, the response looks like this


```
client: ["RETRIEVE","<event-id>"]
relay:  ["OK","<event-id>", false, "missing: not found"]
```
In this case, the relay MUST NOT generate a binary message


**NOTE**: It may indeed happen that binary content is unavailable even though there is an event for it. The client must be prepared for this eventuality. For example, the event might have been incorrectly published, or the relay database may have been corrupted, or the content might been deleted for copyrighted or explicit content.

** error messages **

(examples)

* **missing: not found**
* **missing: removed for legal reasons**
* **missing: removed for explicit content**
* **blocked: unauthorized**
* **blocked: unavailable in current location**



Changes in relay information document (NIP-11)
-----------------------------------------------

New item is added to the "limitation" section

```
 "limitation": {
    "max_file_size": 262144,
  }
```

* **max_file_size** -- maximum size of binary content in bytes.



